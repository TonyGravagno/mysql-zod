import j from"node:path";import z from"fs-extra";import I from"knex";import N from"camelcase";function T(t,b,s){const $=s.nullish&&s.nullish===!0,E=s.requiredString&&s.requiredString===!0,i=t.split("(")[0].split(" ")[0],g=b==="YES",l=["z.string()"],p=["z.number()"],y=$?"nullish()":"nullable()",f="nonnegative()",x="min(1)";let o=s.datetime?.useDate&&s.datetime.useDate||!1,e=s.datetime?.useIso&&s.datetime.useIso||!1;o&&e&&(o=!1,e=!1);const u=o&&(s.datetime?.coerce||!1),c=o&&s.datetime?.minDate||void 0,n=o&&s.datetime?.maxDate||void 0,d=e&&(s.datetime?.offset||!1),C=e&&s.datetime?.precision&&s.datetime.precision>0&&s.datetime.precision<10?s.datetime.precision:void 0,h=w=>{const r=[],a=[];let m=["z"];if(o)return u&&m.push("coerce"),m.push("date()"),c!==void 0&&m.push(`min(new Date('${c}'))`),n!==void 0&&m.push(`max(new Date('${n}'))`),m.join(".");if(e){let D="";return d&&a.push(`offset: ${d}`),C!==void 0&&a.push(`precision: ${C}`),a.length>0&&(D=`{${a.join(",")}}`),l.push(`datetime(${D})`),l.join(".")}return l.join(".")};switch(i){case"date":return h(i);case"datetime":return h(i);case"timestamp":return h(i);case"time":return h(i);case"year":case"char":case"varchar":case"tinytext":case"text":case"mediumtext":case"longtext":case"json":case"decimal":return g?l.push(y):E&&l.push(x),l.join(".");case"tinyint":case"smallint":case"mediumint":case"int":case"bigint":case"float":case"double":return t.endsWith(" unsigned")&&p.push(f),g&&p.push(y),p.join(".");case"enum":return`z.enum([${t.replace("enum(","").replace(")","").replace(/,/g,", ")}])`}}async function R(t){const b=I({client:"mysql2",connection:{host:t.host,port:t.port,user:t.user,password:t.password,database:t.database}}),s=t.camelCase!==void 0&&t.camelCase!==!1,$=e=>s?N(e,typeof t.camelCase!="boolean"?t.camelCase:void 0):e;let i=(await b.raw("SELECT table_name as table_name FROM information_schema.tables WHERE table_schema = ?",[t.database]))[0].map(e=>e.table_name).filter(e=>!e.startsWith("knex_")).sort();const g=t.tables,l=g?.filter(e=>e.startsWith("/")&&e.endsWith("/")),p=g?.filter(e=>l?.includes(e));p&&p.length&&(i=i.filter(e=>{if(p.includes(e))return!0;let u=!1;return l&&l.length&&l.forEach(c=>{const n=c.substring(1,c.length-1);e.match(n)!==null&&(u=!0)}),u}));const y=t.ignore,f=y?.filter(e=>e.startsWith("/")&&e.endsWith("/")),x=y?.filter(e=>!f?.includes(e));x&&x.length&&(i=i.filter(e=>!x.includes(e))),f&&f.length&&(i=i.filter(e=>{let u=!0;return f.forEach(c=>{const n=c.substring(1,c.length-1);e.match(n)!==null&&(u=!1)}),u}));const o=t.modify;for(const e of i){const c=(await b.raw(`DESC ${e}`))[0];let n=e;o&&o.length&&(n=o.reduce((r,a)=>{if(a[0].startsWith("/")&&a[0].endsWith("/")){const D=a[0].substring(1,a[0].length-1);r.match(D)!==null&&(r=r.replace(new RegExp(D),a[1]))}else r=r.replace(a[0],a[1]);return r},n)),n=$(n);let d=`import z from 'zod'

export const ${n} = z.object({`;for(const r of c){const a=s?N(r.Field):r.Field,m=T(r.Type,r.Null,t);d=`${d}
  ${a}: ${m},`}d=`${d}
})

export type ${$(`${n}Type`)} = z.infer<typeof ${n}>
`;const C=t.folder&&t.folder!==""?t.folder:".",h=t.suffix&&t.suffix!==""?`${n}.${t.suffix}.ts`:`${n}.ts`,w=j.join(C,h);console.log("Created:",w),z.outputFileSync(w,d)}await b.destroy()}export{R as generate};
